<!-- trigger pages build -->
<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>服務價值計算器｜Service Value Calculator</title>
    <!-- Tailwind：為了快速部署用 CDN；正式想瘦身可改打包 -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <!-- React 18 / ReactDOM（UMD）-->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel：讓瀏覽器直接跑 JSX（只建議 Demo / GitHub Pages 快速上線） -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      // 取用 React hooks
      const { useState, useMemo } = React;

      // Helper: parse YYYY-MM-DD to a Date at UTC midnight to avoid timezone issues
      function parseDate(dateStr) {
        if (!dateStr) return null;
        const [y, m, d] = dateStr.split("-").map((n) => parseInt(n, 10));
        if (!y || !m || !d) return null;
        return new Date(Date.UTC(y, m - 1, d));
      }

      // Helper: whole-day difference between two UTC-midnight dates
      function diffDays(startDate, endDate, includeEnd = false) {
        if (!startDate || !endDate) return null;
        const ms = endDate.getTime() - startDate.getTime();
        const days = Math.floor(ms / 86400000);
        return includeEnd ? days + 1 : days; // include end date if selected (inclusive range)
      }

      function clamp(num, min, max) {
        return Math.min(Math.max(num, min), max);
      }

      function formatNumber(n, minFrac = 2, maxFrac = 2) {
        if (Number.isNaN(n) || n === null) return "-";
        try {
          return new Intl.NumberFormat(undefined, {
            minimumFractionDigits: minFrac,
            maximumFractionDigits: maxFrac,
          }).format(n);
        } catch (e) {
          return n.toFixed(2);
        }
      }

      function ServiceValueCalculator() {
        const [amount, setAmount] = useState(10000);
        const [startDateStr, setStartDateStr] = useState("");
        const [interruptDateStr, setInterruptDateStr] = useState("");

        const [mode, setMode] = useState("endDate"); // 'endDate' | 'totalDays'
        const [endDateStr, setEndDateStr] = useState("");
        const [totalDaysInput, setTotalDaysInput] = useState("");

        // Used-days counting (for interruption / end day)
        const [countMode, setCountMode] = useState("exclude"); // 'exclude' | 'include'
        const includeEndForUsed = countMode === "include";

        // NEW: total days inclusive option (start + end)
        const [totalInclusive, setTotalInclusive] = useState(true); // default: inclusive of start & end

        const startDate = useMemo(() => parseDate(startDateStr), [startDateStr]);
        const interruptDate = useMemo(() => parseDate(interruptDateStr), [interruptDateStr]);
        const endDate = useMemo(() => parseDate(endDateStr), [endDateStr]);

        // Derived totals & validations
        const { totalDays, usedDays, remainingDays, usedValue, unusedLoss, ratioUsed, errors } = useMemo(() => {
          const errs = [];

          // Total days
          let total = null;
          if (!startDate) {
            errs.push("請輸入服務開始日期 / Please enter start date.");
          }

          if (mode === "endDate") {
            if (!endDate) {
              errs.push("請輸入服務結束日期 / Please enter end date.");
            }
            const d = diffDays(startDate, endDate, totalInclusive);
            if (d === null) {
              total = null;
            } else if (d < 0) {
              errs.push("結束日期必須不早於開始日期 / End date must be on or after start date.");
              total = 0;
            } else {
              total = d;
            }
          } else {
            // mode === 'totalDays'
            const td = parseInt(totalDaysInput, 10);
            if (!Number.isFinite(td)) {
              errs.push("請輸入有效的總服務日數 / Please enter a valid total service days.");
              total = 0;
            } else if (td <= 0) {
              errs.push("總服務日數必須為正數 / Total service days must be > 0.");
              total = 0;
            } else {
              total = td;
            }
          }

          // Used days
          let used = null;
          if (!interruptDate) {
            errs.push("請輸入服務中斷日期 / Please enter interruption date.");
            used = 0;
          } else if (!startDate) {
            used = 0;
          } else {
            const ud = diffDays(startDate, interruptDate, includeEndForUsed);
            if (ud === null) {
              used = 0;
            } else if (ud < 0) {
              errs.push("中斷日期必須不早於開始日期 / Interruption date must be on or after start date.");
              used = 0;
            } else {
              used = ud;
            }
          }

          // Clamp used to not exceed total if both are available
          if (Number.isFinite(total) && Number.isFinite(used)) {
            used = clamp(used, 0, Math.max(0, total));
          }

          // Values
          const amt = Number(amount);
          let usedVal = 0;
          let loss = 0;
          let remain = null;
          let ratio = null;
          if (total > 0) {
            usedVal = (amt * used) / total;
            loss = amt - usedVal;
            remain = Math.max(0, total - used);
            ratio = used / total;
          }

          return {
            totalDays: Number.isFinite(total) ? total : null,
            usedDays: Number.isFinite(used) ? used : null,
            remainingDays: Number.isFinite(remain) ? remain : null,
            usedValue: usedVal,
            unusedLoss: loss,
            ratioUsed: ratio,
            errors: errs,
          };
        }, [amount, startDate, interruptDate, endDate, includeEndForUsed, mode, totalDaysInput, totalInclusive]);

        const canCalc = errors.length === 0 && totalDays > 0 && usedDays !== null;

        return (
          <div className="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
            <div className="max-w-4xl mx-auto">
              <header className="mb-6">
                <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight">
                  服務價值計算器 <span className="text-gray-400">｜</span> <span className="text-gray-700">Service Value Calculator</span>
                </h1>
                <p className="text-gray-600 mt-2 text-sm sm:text-base">
                  根據以下公式進行比例分攤（pro-rata）：已用日數、總服務日數、已使用金額與未使用損失。<br />
                  Pro-rata allocation based on elapsed days, total service days, and amount.
                </p>
              </header>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Inputs */}
                <section className="lg:col-span-2">
                  <div className="bg-white rounded-2xl shadow-sm border p-5 space-y-5">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        金額（Amount）
                      </label>
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="如：10000"
                      />
                    </div>

                    <div className="grid sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">服務開始日期（Start Date）</label>
                        <input
                          type="date"
                          value={startDateStr}
                          onChange={(e) => setStartDateStr(e.target.value)}
                          className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">服務中斷日期（Interruption Date）</label>
                        <input
                          type="date"
                          value={interruptDateStr}
                          onChange={(e) => setInterruptDateStr(e.target.value)}
                          className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                      </div>
                    </div>

                    <div className="grid sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">總服務期輸入方式（How to provide total service）</label>
                        <div className="flex items-center gap-4">
                          <label className="inline-flex items-center gap-2 text-sm">
                            <input
                              type="radio"
                              className="text-indigo-600"
                              checked={mode === "endDate"}
                              onChange={() => setMode("endDate")}
                            />
                            以結束日期（By End Date）
                          </label>
                          <label className="inline-flex items-center gap-2 text-sm">
                            <input
                              type="radio"
                              className="text-indigo-600"
                              checked={mode === "totalDays"}
                              onChange={() => setMode("totalDays")}
                            />
                            以總日數（By Total Days）
                          </label>
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">計數方式（Counting method, for Used Days）</label>
                        <select
                          value={countMode}
                          onChange={(e) => setCountMode(e.target.value)}
                          className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        >
                          <option value="exclude">不計算結束／中斷當日（Exclude end/interruption day）</option>
                          <option value="include">連同結束／中斷當日（Include end/interruption day）</option>
                        </select>
                      </div>
                    </div>

                    {/* NEW: Total days inclusive option */}
                    <div className="grid sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">總服務日數計算（Total days count）</label>
                        <label className="inline-flex items-center gap-2 text-sm">
                          <input
                            type="checkbox"
                            className="text-indigo-600"
                            checked={totalInclusive}
                            onChange={(e) => setTotalInclusive(e.target.checked)}
                          />
                          服務總日數含開始與結束日期（Inclusive of start & end dates）
                        </label>
                        <p className="text-xs text-gray-500 mt-1">例：2025-01-01 至 2025-12-31 = 365 天（含首尾日）。</p>
                      </div>
                    </div>

                    {mode === "endDate" ? (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">服務結束日期（End Date）</label>
                        <input
                          type="date"
                          value={endDateStr}
                          onChange={(e) => setEndDateStr(e.target.value)}
                          className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                      </div>
                    ) : (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">總服務日數（Total Service Days）</label>
                        <input
                          type="number"
                          min="1"
                          step="1"
                          value={totalDaysInput}
                          onChange={(e) => setTotalDaysInput(e.target.value)}
                          className="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="例如：365"
                        />
                        <p className="text-xs text-gray-500 mt-1">* 直接輸入總服務日數；是否含首尾日由您自行決定。本選項僅在「以結束日期」模式時生效。</p>
                      </div>
                    )}

                    {errors.length > 0 && (
                      <div className="bg-red-50 text-red-700 border border-red-200 rounded-xl p-3 text-sm space-y-1">
                        {errors.map((e, i) => (
                          <div key={i}>• {e}</div>
                        ))}
                      </div>
                    )}

                    <div className="flex gap-3">
                      <button
                        type="button"
                        className="px-4 py-2 rounded-xl bg-indigo-600 text-white shadow hover:bg-indigo-700 disabled:opacity-50"
                        disabled={!canCalc}
                        onClick={() => {
                          // Results are computed live; button kept for clarity
                        }}
                      >
                        計算 Calculate
                      </button>
                      <button
                        type="button"
                        className="px-4 py-2 rounded-xl border bg-white text-gray-700 hover:bg-gray-50"
                        onClick={() => {
                          setAmount(10000);
                          setStartDateStr("");
                          setInterruptDateStr("");
                          setMode("endDate");
                          setEndDateStr("");
                          setTotalDaysInput("");
                          setCountMode("exclude");
                          setTotalInclusive(true);
                        }}
                      >
                        重設 Reset
                      </button>
                    </div>

                    <p className="text-xs text-gray-500">
                      注意 / Note：計算為一般性比例分攤示例，實際條款仍以合約或服務協議為準。
                    </p>
                  </div>
                </section>

                {/* Results */}
                <aside className="lg:col-span-1">
                  <div className="bg-white rounded-2xl shadow-sm border p-5 space-y-4">
                    <h2 className="text-lg font-semibold">結果｜Results</h2>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div className="col-span-2 flex items-center justify-between border-b pb-2">
                        <span className="text-gray-600">服務總日數（Total Days）</span>
                        <span className="font-medium">{totalDays ?? "-"}</span>
                      </div>
                      <div className="col-span-2 flex items-center justify-between">
                        <span className="text-gray-600">已使用的日數（Used Days）</span>
                        <span className="font-medium">{usedDays ?? "-"}</span>
                      </div>
                      <div className="col-span-2 flex items-center justify-between">
                        <span className="text-gray-600">餘下日數（Remaining Days）</span>
                        <span className="font-medium">{remainingDays ?? "-"}</span>
                      </div>
                      <div className="col-span-2 border-t pt-2"></div>
                      <div className="col-span-2 flex items-center justify-between">
                        <span className="text-gray-600">已使用的價值（Used Value）</span>
                        <span className="font-semibold">{formatNumber(usedValue)}</span>
                      </div>
                      <div className="col-span-2 flex items-center justify-between">
                        <span className="text-gray-600">沒有使用的損失（Unused Loss）</span>
                        <span className="font-semibold">{formatNumber(unusedLoss)}</span>
                      </div>
                      <div className="col-span-2 flex items-center justify-between text-xs text-gray-500">
                        <span>已用比例（Used Ratio）</span>
                        <span>{ratioUsed === null ? "-" : `${formatNumber(ratioUsed * 100, 2, 2)}%`}</span>
                      </div>
                    </div>

                    <div className="rounded-xl bg-gray-50 p-3 text-xs text-gray-600">
                      <p className="mb-1 font-medium">計算邏輯（Formulas）</p>
                      <ul className="list-disc ml-4 space-y-1">
                        <li>已使用的日數 = 中斷日期 − 開始日期（依上方「計數方式」是否連同當日）</li>
                        <li>服務總日數 = 結束日期 − 開始日期（或直接輸入總日數；若勾選「含首尾日」，則以含首尾日計）</li>
                        <li>已使用的價值 = 金額 × (已使用日數 ÷ 服務總日數)</li>
                        <li>沒有使用的損失 = 金額 − 已使用的價值</li>
                      </ul>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
          </div>
        );
      }

      // 掛載
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ServiceValueCalculator />);
    </script>
  </body>
</html>
